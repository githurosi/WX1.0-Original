name: Auto Update Worker
on:
  push:
    branches:
      - main
  schedule:
    - cron: "0 1 * * *" # æ¯å¤©å‡Œæ™¨1ç‚¹è¿è¡Œ
  workflow_dispatch:
    inputs:
      force_update:
        description: 'æ˜¯å¦å¼ºåˆ¶æ›´æ–°ï¼ˆå¿½ç•¥ç‰ˆæœ¬æ£€æŸ¥ï¼‰'
        required: false
        default: 'false'

permissions:
  contents: write
  actions: read
  packages: read
  repository-projects: read
  security-events: read
  statuses: read
  pull-requests: read
  issues: read
  metadata: read

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - name: æ£€å‡ºå½“å‰ä»“åº“
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # æ‹‰å–å®Œæ•´å†å²è®°å½•ï¼Œç”¨äºç‰ˆæœ¬å¯¹æ¯”

      - name: è®¾ç½®ç¯å¢ƒå˜é‡
        run: |
          echo "REPO_OWNER=bia-pain-bache" >> $GITHUB_ENV
          echo "REPO_NAME=BPB-Worker-Panel" >> $GITHUB_ENV
          echo "TARGET_BRANCH=main" >> $GITHUB_ENV # ç›®æ ‡åˆ†æ”¯ï¼Œå¯æ”¹ä¸ºå…¶ä»–åˆ†æ”¯å¦‚master

      - name: è·å–è¿œç¨‹ä»“åº“æœ€æ–°ä¿¡æ¯
        run: |
          git remote add origin-remote https://github.com/${{ env.REPO_OWNER }}/${{ env.REPO_NAME }}.git
          git fetch origin-remote --depth=1 ${{ env.TARGET_BRANCH }}
          REMOTE_VERSION=$(git ls-remote --tags origin-remote | grep -oP 'refs/tags/v\K[\d.]+' | sort -V | tail -n1) || true
          REMOTE_COMMIT=$(git rev-parse origin-remote/${{ env.TARGET_BRANCH }})
          echo "REMOTE_VERSION=$REMOTE_VERSION" >> $GITHUB_ENV
          echo "REMOTE_COMMIT=$REMOTE_COMMIT" >> $GITHUB_ENV

      - name: æ£€æŸ¥æœ¬åœ°ç‰ˆæœ¬
        run: |
          LOCAL_COMMIT=$(git rev-parse HEAD)
          LOCAL_VERSION=$(cat version.txt 2>/dev/null || echo "0.0.0")
          echo "LOCAL_VERSION=$LOCAL_VERSION" >> $GITHUB_ENV
          echo "LOCAL_COMMIT=$LOCAL_COMMIT" >> $GITHUB_ENV

      - name: åˆ¤æ–­æ˜¯å¦éœ€è¦æ›´æ–°
        run: |
          FORCE_UPDATE=${{ github.event.inputs.force_update || 'false' }}
          if [ "$FORCE_UPDATE" == "true" ] || [ "$LOCAL_COMMIT" != "$REMOTE_COMMIT" ]; then
            echo "éœ€è¦æ›´æ–°ï¼ˆå¼ºåˆ¶æ›´æ–°æˆ–è¿œç¨‹æœ‰æ–°æäº¤ï¼‰"
            exit 0
          else
            echo "å·²æ˜¯æœ€æ–°ç‰ˆæœ¬ï¼Œæ— éœ€æ›´æ–°"
            exit 1
          fi
        id: need_update

      - name: å…‹éš†æˆ–æ›´æ–°è¿œç¨‹ä»“åº“
        if: steps.need_update.outcome == 'success'
        run: |
          # å…‹éš†æˆ–æ‹‰å–æœ€æ–°ä»£ç 
          git clone --depth=1 https://github.com/${{ env.REPO_OWNER }}/${{ env.REPO_NAME }}.git temp-repo
          cd temp-repo
          git checkout ${{ env.TARGET_BRANCH }}
          # å¤åˆ¶ç›®æ ‡æ–‡ä»¶åˆ°å½“å‰ä»“åº“ï¼ˆå¯æ ¹æ®å®é™…éœ€æ±‚ä¿®æ”¹æ–‡ä»¶è·¯å¾„ï¼‰
          cp -r ./* ../
          cd ..
          rm -rf temp-repo
          # æ›´æ–°ç‰ˆæœ¬å·ï¼ˆå¯é€‰ï¼Œæ ¹æ®ä»“åº“å®é™…ç‰ˆæœ¬ç®¡ç†æ–¹å¼è°ƒæ•´ï¼‰
          CURRENT_VERSION=$(git describe --tags --always 2>/dev/null || echo "unknown")
          echo "$CURRENT_VERSION" > version.txt

      - name: æäº¤æ›´æ–°
        if: steps.need_update.outcome == 'success'
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "ğŸ”„ è‡ªåŠ¨æ›´æ–°ä»“åº“ä»£ç è‡³ ${REMOTE_VERSION}"
          commit_author: "github-actions[bot] <github-actions[bot]@users.noreply.github.com>"
          branch: main # æäº¤åˆ°å½“å‰ä»“åº“çš„mainåˆ†æ”¯
